<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Public Messenger</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f0f2f5;
      color: #222;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background: #e5e5e5;
    }
    .message {
      background: #fff;
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 10px;
      max-width: 80%;
      animation: bounceIn 0.3s ease forwards;
    }
    .meta {
      font-size: 12px;
      color: #555;
      margin-bottom: 4px;
    }
    @keyframes bounceIn {
      0% { transform: scale(0.95); opacity: 0; }
      80% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(1); }
    }
    #typingIndicator {
      font-style: italic;
      font-size: 13px;
      padding: 5px 15px;
      color: #666;
    }
    form {
      display: flex;
      padding: 10px;
      background: #fff;
    }
    form input {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    form button {
      padding: 10px 20px;
      margin-left: 10px;
      border-radius: 20px;
      background: #007bff;
      color: white;
      border: none;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div id="messages"></div>
<div id="typingIndicator"></div>

<form id="form">
  <input id="input" autocomplete="off" placeholder="Type a message..." />
  <button>Send</button>
</form>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCJMj0T5Hny_pCmfcwA_BQVU6HU6OX9QXU",
  authDomain: "publicmessenger-1a1a2.firebaseapp.com",
  databaseURL: "https://publicmessenger-1a1a2-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "publicmessenger-1a1a2",
  storageBucket: "publicmessenger-1a1a2.appspot.com",
  messagingSenderId: "786562136202",
  appId: "1:786562136202:web:355d776f74ef55158bd573"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const messagesRef = db.ref("messages");
const typingRef = db.ref("typing");

const input = document.getElementById("input");
const form = document.getElementById("form");
const messages = document.getElementById("messages");
const typingIndicator = document.getElementById("typingIndicator");

let username = localStorage.getItem("username");
if (!username) {
  username = prompt("Enter your name:");
  localStorage.setItem("username", username || "Anonymous");
}

form.addEventListener("submit", (e) => {
  e.preventDefault();
  if (!input.value) return;

  const msg = {
    user: username,
    text: input.value,
    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
  };
  messagesRef.push(msg);
  input.value = "";
  typingRef.set(""); // Clear typing status
});

input.addEventListener("input", () => {
  typingRef.set(username + " is typing...");
  clearTimeout(input._typingTimeout);
  input._typingTimeout = setTimeout(() => typingRef.set(""), 3000);
});

messagesRef.on("child_added", (snap) => {
  const msg = snap.val();
  const div = document.createElement("div");
  div.className = "message";
  div.innerHTML = `<div class="meta"><b>${msg.user}</b> â€¢ ${msg.time}</div>${msg.text}`;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;

  // Push Notification
  if (Notification.permission === "granted" && msg.user !== username) {
    new Notification(`${msg.user}: ${msg.text}`);
  }
});

typingRef.on("value", (snap) => {
  typingIndicator.textContent = snap.val() || "";
});

// Ask for notification permission
if ("Notification" in window && Notification.permission !== "granted") {
  Notification.requestPermission();
}
</script>

</body>
</html>
